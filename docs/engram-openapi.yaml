openapi: 3.0.3
info:
  title: Engram API
  description: |
    Lore persistence and synchronization service for AI agent memory.

    Engram provides a central repository for experiential knowledge (lore) that
    AI agents accumulate during development sessions. Features include semantic
    deduplication, confidence scoring, feedback integration, and efficient sync.

    ## Multi-Store Support (v1.1)

    Engram supports isolated stores for multi-project deployments. Each store
    maintains its own lore collection with independent snapshots and statistics.

    - **Default store**: Auto-created, used by legacy `/lore/*` routes
    - **Named stores**: Created via `POST /stores`, accessed via `/stores/{store_id}/lore/*`
    - **Backward compatible**: Existing clients work without changes
  version: 1.1.0
  contact:
    name: Engram Team
  license:
    name: MIT

servers:
  - url: http://localhost:8080/api/v1
    description: Local development
  - url: https://your-engram-instance.example.com/api/v1
    description: Production (replace with your deployment URL)

tags:
  - name: Health
    description: Service health and status
  - name: Monitoring
    description: Extended system metrics and monitoring
  - name: Stores
    description: Multi-store management for isolated lore collections
  - name: Lore
    description: Lore ingestion and retrieval
  - name: Sync
    description: Snapshot and delta synchronization
  - name: Feedback
    description: Lore quality feedback

paths:
  /health:
    get:
      tags: [Health]
      summary: Check service health
      description: |
        Returns service status, version, and configuration. No authentication required.

        Use the optional `store` query parameter to get stats for a specific store.
        Without this parameter, returns stats for the default store.
      operationId: getHealth
      security: []
      parameters:
        - name: store
          in: query
          required: false
          schema:
            type: string
            example: "neuralmux/engram"
          description: |
            Store ID for store-specific health stats.
            If omitted, returns stats for the default store.
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                default:
                  summary: Default store health
                  value:
                    status: "healthy"
                    version: "1.0.0"
                    embedding_model: "text-embedding-3-small"
                    lore_count: 1523
                    last_snapshot: "2026-01-29T14:30:00Z"
                store_specific:
                  summary: Store-specific health
                  value:
                    status: "healthy"
                    version: "1.0.0"
                    embedding_model: "text-embedding-3-small"
                    lore_count: 847
                    last_snapshot: "2026-01-29T14:30:00Z"
                    store_id: "neuralmux/engram"
        '400':
          description: Invalid store ID format
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '404':
          description: Store not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'

  /stats:
    get:
      summary: Get extended system statistics
      description: |
        Returns comprehensive system metrics including lore counts, embedding pipeline health,
        category distribution, and quality metrics. This endpoint is public (no authentication
        required) to enable monitoring tool integration.
      operationId: getStats
      tags:
        - Monitoring
      security: []
      responses:
        '200':
          description: Extended statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedStats'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'

  # === Store Management Endpoints ===

  /stores:
    get:
      tags: [Stores]
      summary: List all stores
      description: |
        Returns a list of all stores with summary information including
        record counts and storage sizes. Stores are sorted alphabetically by ID.
      operationId: listStores
      responses:
        '200':
          description: List of stores
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListStoresResponse'
              example:
                stores:
                  - id: "default"
                    record_count: 1523
                    last_accessed: "2026-01-31T10:30:00Z"
                    size_bytes: 4194304
                    description: "Default store (auto-created)"
                  - id: "neuralmux/engram"
                    record_count: 847
                    last_accessed: "2026-01-31T09:15:00Z"
                    size_bytes: 2097152
                    description: "Engram project lore"
                total: 2
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '503':
          description: Multi-store support not configured
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'

    post:
      tags: [Stores]
      summary: Create a new store
      description: |
        Creates a new isolated store for lore entries. The default store is
        auto-created on first access and does not need explicit creation.

        **Store ID Format:**
        - Lowercase alphanumeric characters and hyphens only
        - Path segments separated by `/` (max 4 levels)
        - Maximum 128 characters total
        - Must start and end with alphanumeric (no leading/trailing hyphens)
        - Examples: `myproject`, `org/team/project`, `neuralmux/engram`
      operationId: createStore
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateStoreRequest'
            example:
              store_id: "neuralmux/recall"
              description: "Recall client lore"
      responses:
        '201':
          description: Store created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateStoreResponse'
              example:
                id: "neuralmux/recall"
                created: "2026-01-31T11:00:00Z"
                description: "Recall client lore"
        '400':
          description: Invalid store ID format
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              example:
                type: "https://engram.dev/errors/bad-request"
                title: "Bad Request"
                status: 400
                detail: "invalid store ID: must be lowercase alphanumeric with hyphens"
                instance: "/api/v1/stores"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Store already exists
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              example:
                type: "https://engram.dev/errors/conflict"
                title: "Conflict"
                status: 409
                detail: "Store already exists: neuralmux/recall"
                instance: "/api/v1/stores"
        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '503':
          description: Multi-store support not configured
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'

  /stores/{store_id}:
    get:
      tags: [Stores]
      summary: Get store information
      description: |
        Returns detailed information about a specific store including
        extended statistics (lore counts, embedding stats, quality metrics).
      operationId: getStoreInfo
      parameters:
        - $ref: '#/components/parameters/StoreIdPath'
      responses:
        '200':
          description: Store information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreInfoResponse'
              example:
                id: "neuralmux/engram"
                created: "2026-01-15T08:00:00Z"
                last_accessed: "2026-01-31T10:30:00Z"
                description: "Engram project lore"
                size_bytes: 2097152
                stats:
                  total_lore: 850
                  active_lore: 847
                  deleted_lore: 3
                  embedding_stats:
                    complete: 840
                    pending: 7
                    failed: 0
                  category_stats:
                    ARCHITECTURAL_DECISION: 125
                    PATTERN_OUTCOME: 89
                  quality_stats:
                    average_confidence: 0.72
                    validated_count: 156
                    high_confidence_count: 312
                    low_confidence_count: 45
                  unique_source_count: 8
                  stats_as_of: "2026-01-31T10:30:00Z"
        '400':
          description: Invalid store ID format
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Store not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '503':
          description: Multi-store support not configured
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'

    delete:
      tags: [Stores]
      summary: Delete a store
      description: |
        Permanently deletes a store and all its lore data.

        **Safeguards:**
        - Requires `confirm=true` query parameter
        - The `default` store cannot be deleted (returns 403)

        **Warning:** This operation is irreversible.
      operationId: deleteStore
      parameters:
        - $ref: '#/components/parameters/StoreIdPath'
        - name: confirm
          in: query
          required: true
          schema:
            type: string
            enum: ["true"]
          description: Must be `true` to confirm deletion
      responses:
        '204':
          description: Store deleted successfully
        '400':
          description: Missing confirm=true parameter or invalid store ID
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              example:
                type: "https://engram.dev/errors/bad-request"
                title: "Bad Request"
                status: 400
                detail: "Delete requires confirm=true query parameter"
                instance: "/api/v1/stores/neuralmux%2Fengram"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Cannot delete the default store
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              example:
                type: "https://engram.dev/errors/forbidden"
                title: "Forbidden"
                status: 403
                detail: "Cannot delete the default store"
                instance: "/api/v1/stores/default"
        '404':
          description: Store not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '503':
          description: Multi-store support not configured
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'

  # === Store-Scoped Lore Endpoints ===

  /stores/{store_id}/lore:
    post:
      tags: [Lore]
      summary: Ingest lore entries (store-scoped)
      description: |
        Submit a batch of lore entries to a specific store. Identical to
        `POST /lore` but targets the specified store instead of the default.

        See [Ingest Lore](#/Lore/ingestLore) for full documentation.
      operationId: ingestLoreToStore
      parameters:
        - $ref: '#/components/parameters/StoreIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IngestRequest'
      responses:
        '200':
          description: Batch processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestResult'
        '400':
          description: Invalid JSON syntax or store ID
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Store not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '422':
          description: Request-level validation failed
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetailsWithErrors'

  /stores/{store_id}/lore/snapshot:
    get:
      tags: [Sync]
      summary: Download full snapshot (store-scoped)
      description: |
        Download a complete database snapshot for a specific store.
        See [Get Snapshot](#/Sync/getSnapshot) for full documentation.
      operationId: getSnapshotFromStore
      parameters:
        - $ref: '#/components/parameters/StoreIdPath'
        - name: X-Recall-Source-ID
          in: header
          required: false
          schema:
            type: string
          description: Client source identifier for observability
      responses:
        '200':
          description: SQLite database snapshot
          headers:
            Content-Disposition:
              schema:
                type: string
              description: Suggested filename for the download
              example: 'attachment; filename="engram-snapshot.db"'
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Store not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '503':
          description: Snapshot not yet available
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds to wait before retrying
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'

  /stores/{store_id}/lore/delta:
    get:
      tags: [Sync]
      summary: Get incremental changes (store-scoped)
      description: |
        Retrieve lore changes since a given timestamp from a specific store.
        See [Get Delta](#/Sync/getDelta) for full documentation.
      operationId: getDeltaFromStore
      parameters:
        - $ref: '#/components/parameters/StoreIdPath'
        - name: X-Recall-Source-ID
          in: header
          required: false
          schema:
            type: string
          description: Client source identifier for observability
        - name: since
          in: query
          required: true
          schema:
            type: string
            format: date-time
          description: RFC3339 timestamp to get changes from
      responses:
        '200':
          description: Delta changes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeltaResult'
        '400':
          description: Invalid or missing since parameter
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Store not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'

  /stores/{store_id}/lore/feedback:
    post:
      tags: [Feedback]
      summary: Submit lore feedback (store-scoped)
      description: |
        Submit batch feedback on lore entries in a specific store.
        See [Submit Feedback](#/Feedback/submitFeedback) for full documentation.
      operationId: submitFeedbackToStore
      parameters:
        - $ref: '#/components/parameters/StoreIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeedbackRequest'
      responses:
        '200':
          description: Feedback processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeedbackResult'
        '400':
          description: Invalid JSON syntax
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Store or lore entry not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '422':
          description: Validation failed
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetailsWithErrors'

  /stores/{store_id}/lore/{id}:
    delete:
      tags: [Lore]
      summary: Delete a lore entry (store-scoped)
      description: |
        Soft-delete a specific lore entry from a store. The entry will be
        marked as deleted and included in delta sync `deleted_ids`.

        **Rate Limiting:** DELETE operations are rate-limited to prevent abuse
        (100 burst, 10/second sustained).
      operationId: deleteLoreFromStore
      parameters:
        - $ref: '#/components/parameters/StoreIdPath'
        - name: id
          in: path
          required: true
          schema:
            type: string
            pattern: '^[0-9A-HJKMNP-TV-Z]{26}$'
          description: ULID of the lore entry to delete
      responses:
        '204':
          description: Lore entry deleted
        '400':
          description: Invalid lore ID format
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Store or lore entry not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '429':
          description: Rate limit exceeded
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds to wait before retrying
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'

  # === Default Store Lore Endpoints ===

  /lore:
    post:
      tags: [Lore]
      summary: Ingest lore entries
      description: |
        Submit a batch of lore entries for persistence. Entries are validated,
        embedded, deduplicated, and stored. Semantically equivalent entries
        are merged rather than duplicated.

        **Partial acceptance**: Valid entries are accepted even if others fail.
        Check the `rejected` count and `errors` array for failed entries.
      operationId: ingestLore
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IngestRequest'
            example:
              source_id: "devcontainer-abc123"
              lore:
                - content: "SQLite requires explicit BEGIN for write transactions"
                  category: "DEPENDENCY_BEHAVIOR"
                  confidence: 0.8
                - content: "Using defer for cleanup ensures resources are released"
                  context: "Discovered during code review"
                  category: "PATTERN_OUTCOME"
                  confidence: 0.9
      responses:
        '200':
          description: Batch processed (check rejected count for failures)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestResult'
              example:
                accepted: 2
                merged: 0
                rejected: 0
                errors: []
        '400':
          description: Invalid JSON syntax
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          description: Request-level validation failed (empty batch, missing source_id)
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetailsWithErrors'

  /lore/snapshot:
    get:
      tags: [Sync]
      summary: Download full snapshot
      description: |
        Download a complete database snapshot for initial bootstrap.
        Returns a SQLite database file containing all lore entries with
        embeddings for client-side semantic search.
      operationId: getSnapshot
      parameters:
        - name: X-Recall-Source-ID
          in: header
          required: false
          schema:
            type: string
            example: "devcontainer-abc123"
          description: |
            Client source identifier for observability and logging.
            Should match the source_id used in ingest and feedback requests.
            When provided, enables per-client activity tracking in server logs.
      responses:
        '200':
          description: SQLite database snapshot
          headers:
            Content-Disposition:
              schema:
                type: string
              description: Suggested filename for the download
              example: 'attachment; filename="engram-snapshot.db"'
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/Unauthorized'
        '503':
          description: Snapshot not yet available
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds to wait before retrying
              example: 60
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'

  /lore/delta:
    get:
      tags: [Sync]
      summary: Get incremental changes
      description: |
        Retrieve lore changes since a given timestamp. Returns new/updated
        entries and IDs of deleted entries. Use the `as_of` timestamp from
        the response for the next delta request.
      operationId: getDelta
      parameters:
        - name: X-Recall-Source-ID
          in: header
          required: false
          schema:
            type: string
            example: "devcontainer-abc123"
          description: |
            Client source identifier for observability and logging.
            Should match the source_id used in ingest and feedback requests.
            When provided, enables per-client activity tracking in server logs.
        - name: since
          in: query
          required: true
          schema:
            type: string
            format: date-time
          description: RFC3339 timestamp to get changes from
          example: "2026-01-28T00:00:00Z"
      responses:
        '200':
          description: Delta changes since the given timestamp
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeltaResult'
              example:
                lore:
                  - id: "01ARZ3NDEKTSV4RRFFQ69G5FAV"
                    content: "SQLite requires explicit BEGIN for write transactions"
                    category: "DEPENDENCY_BEHAVIOR"
                    confidence: 0.8
                    sources: ["devcontainer-abc123"]
                    validation_count: 2
                    created_at: "2026-01-28T10:00:00Z"
                    updated_at: "2026-01-29T14:30:00Z"
                    embedding_status: "ready"
                deleted_ids: []
                as_of: "2026-01-29T14:35:00Z"
        '400':
          description: Invalid or missing `since` parameter
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              example:
                type: "https://engram.dev/errors/bad-request"
                title: "Bad Request"
                status: 400
                detail: "since parameter must be a valid RFC3339 timestamp"
                instance: "/api/v1/lore/delta"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /lore/feedback:
    post:
      tags: [Feedback]
      summary: Submit lore feedback
      description: |
        Submit batch feedback on lore entries. Feedback affects confidence scores:

        - `helpful`: +0.08 confidence, increments validation_count, updates last_validated_at
        - `incorrect`: -0.15 confidence
        - `not_relevant`: no change (acknowledgment only)

        Confidence is capped at 1.0 and floored at 0.0.

        **Fail-fast**: If any lore_id does not exist, the entire batch is rejected.
      operationId: submitFeedback
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeedbackRequest'
            example:
              source_id: "devcontainer-abc123"
              feedback:
                - lore_id: "01ARZ3NDEKTSV4RRFFQ69G5FAV"
                  type: "helpful"
                - lore_id: "01ARZ3NDEKTSV4RRFFQ69G5FAW"
                  type: "incorrect"
      responses:
        '200':
          description: Feedback processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeedbackResult'
              example:
                updates:
                  - lore_id: "01ARZ3NDEKTSV4RRFFQ69G5FAV"
                    previous_confidence: 0.72
                    current_confidence: 0.80
                    validation_count: 3
                  - lore_id: "01ARZ3NDEKTSV4RRFFQ69G5FAW"
                    previous_confidence: 0.65
                    current_confidence: 0.50
        '400':
          description: Invalid JSON syntax
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: One or more lore_id values not found (entire batch rejected)
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              example:
                type: "https://engram.dev/errors/not-found"
                title: "Not Found"
                status: 404
                detail: "Resource not found"
                instance: "/api/v1/lore/feedback"
        '422':
          description: Validation failed (invalid ULID, invalid type, etc.)
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetailsWithErrors'

  /lore/{id}:
    delete:
      tags: [Lore]
      summary: Delete a lore entry
      description: |
        Soft-delete a specific lore entry from the default store. The entry
        will be marked as deleted and included in delta sync `deleted_ids`.

        **Rate Limiting:** DELETE operations are rate-limited to prevent abuse
        (100 burst, 10/second sustained).

        For store-scoped deletion, use `DELETE /stores/{store_id}/lore/{id}`.
      operationId: deleteLore
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            pattern: '^[0-9A-HJKMNP-TV-Z]{26}$'
          description: ULID of the lore entry to delete
          example: "01ARZ3NDEKTSV4RRFFQ69G5FAV"
      responses:
        '204':
          description: Lore entry deleted successfully
        '400':
          description: Invalid lore ID format
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              example:
                type: "https://engram.dev/errors/bad-request"
                title: "Bad Request"
                status: 400
                detail: "Invalid lore ID format: must be valid ULID"
                instance: "/api/v1/lore/invalid-id"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Lore entry not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              example:
                type: "https://engram.dev/errors/not-found"
                title: "Not Found"
                status: 404
                detail: "Lore entry not found"
                instance: "/api/v1/lore/01ARZ3NDEKTSV4RRFFQ69G5FAV"
        '429':
          description: Rate limit exceeded
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds to wait before retrying
              example: 1
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              example:
                type: "https://engram.dev/errors/rate-limit"
                title: "Too Many Requests"
                status: 429
                detail: "Rate limit exceeded for DELETE operations"
                instance: "/api/v1/lore/01ARZ3NDEKTSV4RRFFQ69G5FAV"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: |
        API key authentication via Bearer token.
        Include header: `Authorization: Bearer <your-api-key>`

  parameters:
    StoreIdPath:
      name: store_id
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/StoreID'
      description: |
        Store identifier. Must be URL-encoded if it contains forward slashes.
        Example: `neuralmux%2Fengram` for `neuralmux/engram`

  schemas:
    # === Store Types ===

    StoreID:
      type: string
      description: |
        Store identifier following these rules:
        - Lowercase alphanumeric characters and hyphens only
        - Path segments separated by `/` (max 4 levels)
        - Maximum 128 characters total
        - Each segment must start and end with alphanumeric
        - No empty segments allowed
      pattern: '^[a-z0-9]([a-z0-9-]*[a-z0-9])?(\/[a-z0-9]([a-z0-9-]*[a-z0-9])?){0,3}$'
      maxLength: 128
      example: "neuralmux/engram"

    StoreListItem:
      type: object
      description: Summary information for a store in list responses
      required:
        - id
        - record_count
        - last_accessed
        - size_bytes
      properties:
        id:
          $ref: '#/components/schemas/StoreID'
        record_count:
          type: integer
          format: int64
          description: Number of lore entries in the store
          example: 1523
        last_accessed:
          type: string
          format: date-time
          description: Timestamp of last store access
          example: "2026-01-31T10:30:00Z"
        size_bytes:
          type: integer
          format: int64
          description: Database file size in bytes
          example: 4194304
        description:
          type: string
          description: Optional human-readable description
          example: "Default store (auto-created)"

    ListStoresResponse:
      type: object
      description: Response for listing all stores
      required:
        - stores
        - total
      properties:
        stores:
          type: array
          items:
            $ref: '#/components/schemas/StoreListItem'
          description: List of stores sorted alphabetically by ID
        total:
          type: integer
          description: Total number of stores
          example: 2

    StoreInfoResponse:
      type: object
      description: Detailed information about a specific store
      required:
        - id
        - created
        - last_accessed
        - size_bytes
        - stats
      properties:
        id:
          $ref: '#/components/schemas/StoreID'
        created:
          type: string
          format: date-time
          description: Store creation timestamp
          example: "2026-01-15T08:00:00Z"
        last_accessed:
          type: string
          format: date-time
          description: Timestamp of last store access
          example: "2026-01-31T10:30:00Z"
        description:
          type: string
          description: Optional human-readable description
          example: "Engram project lore"
        size_bytes:
          type: integer
          format: int64
          description: Database file size in bytes
          example: 2097152
        stats:
          $ref: '#/components/schemas/ExtendedStats'

    CreateStoreRequest:
      type: object
      description: Request body for creating a new store
      required:
        - store_id
      properties:
        store_id:
          $ref: '#/components/schemas/StoreID'
        description:
          type: string
          maxLength: 500
          description: Optional human-readable description
          example: "Recall client lore"

    CreateStoreResponse:
      type: object
      description: Response after successfully creating a store
      required:
        - id
        - created
      properties:
        id:
          $ref: '#/components/schemas/StoreID'
        created:
          type: string
          format: date-time
          description: Store creation timestamp
          example: "2026-01-31T11:00:00Z"
        description:
          type: string
          description: Store description if provided
          example: "Recall client lore"

    # === Core Types ===

    LoreEntry:
      type: object
      description: A discrete unit of experiential knowledge
      required:
        - id
        - content
        - category
        - confidence
        - sources
        - validation_count
        - created_at
        - updated_at
        - embedding_status
      properties:
        id:
          type: string
          pattern: '^[0-9A-HJKMNP-TV-Z]{26}$'
          description: ULID identifier (Crockford Base32, 26 characters)
          example: "01ARZ3NDEKTSV4RRFFQ69G5FAV"
        content:
          type: string
          maxLength: 4000
          description: The lore content text
          example: "SQLite requires explicit BEGIN for write transactions"
        context:
          type: string
          maxLength: 1000
          description: Additional context about when/where this was learned
          example: "Discovered during performance profiling"
        category:
          $ref: '#/components/schemas/Category'
        confidence:
          type: number
          format: double
          minimum: 0.0
          maximum: 1.0
          description: Confidence score (0.0 = low, 1.0 = high)
          example: 0.85
        embedding:
          type: array
          items:
            type: number
            format: float
          description: 1536-dimensional embedding vector (text-embedding-3-small)
        source_id:
          type: string
          description: Primary source environment identifier
          example: "devcontainer-abc123"
        sources:
          type: array
          items:
            type: string
          description: All source environment identifiers that contributed
          example: ["devcontainer-abc123", "devcontainer-def456"]
        validation_count:
          type: integer
          minimum: 0
          description: Number of times marked as helpful
          example: 5
        last_validated_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp of last helpful feedback
          example: "2026-01-29T14:30:00Z"
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
          example: "2026-01-28T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Last modification timestamp
          example: "2026-01-29T14:30:00Z"
        deleted_at:
          type: string
          format: date-time
          nullable: true
          description: Soft deletion timestamp (null if active)
        embedding_status:
          type: string
          enum: [pending, ready, failed]
          description: Status of embedding generation
          example: "ready"

    NewLoreEntry:
      type: object
      description: Input for creating a new lore entry
      required:
        - content
        - category
        - confidence
      properties:
        content:
          type: string
          minLength: 1
          maxLength: 4000
          description: The lore content text (required, non-empty)
        context:
          type: string
          maxLength: 1000
          description: Additional context (optional)
        category:
          $ref: '#/components/schemas/Category'
        confidence:
          type: number
          format: double
          minimum: 0.0
          maximum: 1.0
          description: Initial confidence score

    Category:
      type: string
      description: Classification of lore type
      enum:
        - ARCHITECTURAL_DECISION
        - PATTERN_OUTCOME
        - INTERFACE_LESSON
        - EDGE_CASE_DISCOVERY
        - IMPLEMENTATION_FRICTION
        - TESTING_STRATEGY
        - DEPENDENCY_BEHAVIOR
        - PERFORMANCE_INSIGHT
      example: "DEPENDENCY_BEHAVIOR"

    # === Request/Response Types ===

    IngestRequest:
      type: object
      description: Batch lore ingestion request
      required:
        - source_id
        - lore
      properties:
        source_id:
          type: string
          minLength: 1
          description: Source environment identifier
          example: "devcontainer-abc123"
        lore:
          type: array
          items:
            $ref: '#/components/schemas/NewLoreEntry'
          minItems: 1
          maxItems: 50
          description: Lore entries to ingest (1-50 per batch)
        flush:
          type: boolean
          default: false
          description: |
            If true, indicates this is a shutdown flush operation.
            The server may prioritize processing these entries.
            Used during client shutdown to ensure all pending lore is persisted.

    IngestResult:
      type: object
      description: Result of batch ingestion
      properties:
        accepted:
          type: integer
          minimum: 0
          description: New entries created
          example: 2
        merged:
          type: integer
          minimum: 0
          description: Entries merged with existing (semantic duplicates)
          example: 1
        rejected:
          type: integer
          minimum: 0
          description: Entries that failed validation
          example: 0
        errors:
          type: array
          items:
            type: string
          description: Error messages for rejected entries
          example: ["lore[2].content: exceeds maximum length of 4000 characters"]

    DeltaResult:
      type: object
      description: Incremental changes since a timestamp
      properties:
        lore:
          type: array
          items:
            $ref: '#/components/schemas/LoreEntry'
          description: New or updated lore entries
        deleted_ids:
          type: array
          items:
            type: string
          description: IDs of deleted entries
          example: ["01ARZ3NDEKTSV4RRFFQ69G5FAX"]
        as_of:
          type: string
          format: date-time
          description: Timestamp for next delta request
          example: "2026-01-29T14:35:00Z"

    FeedbackRequest:
      type: object
      description: Batch feedback submission
      required:
        - source_id
        - feedback
      properties:
        source_id:
          type: string
          minLength: 1
          description: Source environment identifier
          example: "devcontainer-abc123"
        feedback:
          type: array
          items:
            $ref: '#/components/schemas/FeedbackEntry'
          minItems: 1
          maxItems: 50
          description: Feedback entries (1-50 per batch)

    FeedbackEntry:
      type: object
      description: Single feedback item
      required:
        - lore_id
        - type
      properties:
        lore_id:
          type: string
          pattern: '^[0-9A-HJKMNP-TV-Z]{26}$'
          description: ULID of the lore entry
          example: "01ARZ3NDEKTSV4RRFFQ69G5FAV"
        type:
          type: string
          enum: [helpful, not_relevant, incorrect]
          description: |
            Feedback type:
            - helpful: +0.08 confidence
            - incorrect: -0.15 confidence
            - not_relevant: no change
          example: "helpful"

    FeedbackResult:
      type: object
      description: Result of feedback submission
      properties:
        updates:
          type: array
          items:
            $ref: '#/components/schemas/FeedbackResultUpdate'
          description: Confidence changes for each entry

    FeedbackResultUpdate:
      type: object
      description: Confidence change for a single entry
      required:
        - lore_id
        - previous_confidence
        - current_confidence
      properties:
        lore_id:
          type: string
          description: ULID of the affected entry
          example: "01ARZ3NDEKTSV4RRFFQ69G5FAV"
        previous_confidence:
          type: number
          format: double
          description: Confidence before feedback
          example: 0.72
        current_confidence:
          type: number
          format: double
          description: Confidence after feedback
          example: 0.80
        validation_count:
          type: integer
          nullable: true
          description: |
            Updated validation count. Only present for "helpful" feedback.
            Omitted for "incorrect" and "not_relevant" feedback types.
          example: 3

    HealthResponse:
      type: object
      description: Service health information
      properties:
        status:
          type: string
          enum: [healthy]
          description: Service status
          example: "healthy"
        version:
          type: string
          description: API version
          example: "1.0.0"
        embedding_model:
          type: string
          description: Embedding model in use
          example: "text-embedding-3-small"
        lore_count:
          type: integer
          description: Total lore entries stored
          example: 1523
        last_snapshot:
          type: string
          format: date-time
          nullable: true
          description: Timestamp of last snapshot generation
          example: "2026-01-29T14:30:00Z"
        store_id:
          type: string
          description: |
            Store ID (only present when `?store=` query parameter was specified).
            Omitted for default store health checks without the parameter.
          example: "neuralmux/engram"

    ExtendedStats:
      type: object
      required:
        - total_lore
        - active_lore
        - deleted_lore
        - embedding_stats
        - snapshot_stats
        - category_stats
        - quality_stats
        - unique_source_count
        - stats_as_of
      properties:
        total_lore:
          type: integer
          format: int64
          description: Total lore entries (including deleted)
          example: 1523
        active_lore:
          type: integer
          format: int64
          description: Non-deleted lore entries
          example: 1498
        deleted_lore:
          type: integer
          format: int64
          description: Soft-deleted lore entries
          example: 25
        embedding_stats:
          $ref: '#/components/schemas/EmbeddingStats'
        snapshot_stats:
          $ref: '#/components/schemas/SnapshotStats'
        category_stats:
          type: object
          additionalProperties:
            type: integer
            format: int64
          description: Count of active lore entries per category
          example:
            ARCHITECTURAL_DECISION: 234
            PATTERN_OUTCOME: 312
        quality_stats:
          $ref: '#/components/schemas/QualityStats'
        unique_source_count:
          type: integer
          format: int64
          description: Number of distinct source IDs contributing lore
          example: 12
        last_snapshot:
          type: string
          format: date-time
          nullable: true
          description: "Deprecated: Use snapshot_stats.generated_at. Timestamp of last snapshot generation."
          example: "2026-01-30T14:30:00Z"
          deprecated: true
        last_decay:
          type: string
          format: date-time
          nullable: true
          description: Timestamp of last confidence decay run
          example: "2026-01-29T00:00:00Z"
        stats_as_of:
          type: string
          format: date-time
          description: Timestamp when these stats were computed
          example: "2026-01-30T15:45:32Z"

    SnapshotStats:
      type: object
      description: Observability metrics for the current database snapshot
      required:
        - lore_count
        - size_bytes
        - age_seconds
        - pending_entries
        - available
      properties:
        lore_count:
          type: integer
          format: int64
          description: Number of active lore entries captured in the snapshot
          example: 79
        size_bytes:
          type: integer
          format: int64
          description: Snapshot file size in bytes
          example: 1048576
        generated_at:
          type: string
          format: date-time
          nullable: true
          description: When the snapshot was generated
          example: "2026-01-31T08:18:54Z"
        age_seconds:
          type: integer
          format: int64
          description: Seconds elapsed since snapshot generation
          example: 3282
        pending_entries:
          type: integer
          format: int64
          description: Lore entries ingested since last snapshot (active_lore - lore_count). High values indicate stale snapshot.
          example: 45
        available:
          type: boolean
          description: Whether a snapshot exists
          example: true

    EmbeddingStats:
      type: object
      required:
        - complete
        - pending
        - failed
      properties:
        complete:
          type: integer
          format: int64
          description: Entries with successfully generated embeddings
          example: 1480
        pending:
          type: integer
          format: int64
          description: Entries awaiting embedding generation
          example: 15
        failed:
          type: integer
          format: int64
          description: Entries where embedding generation failed
          example: 3

    QualityStats:
      type: object
      required:
        - average_confidence
        - validated_count
        - high_confidence_count
        - low_confidence_count
      properties:
        average_confidence:
          type: number
          format: double
          description: Mean confidence across all active lore
          example: 0.72
        validated_count:
          type: integer
          format: int64
          description: Entries that have received positive feedback
          example: 823
        high_confidence_count:
          type: integer
          format: int64
          description: Entries with confidence >= 0.8
          example: 456
        low_confidence_count:
          type: integer
          format: int64
          description: Entries with confidence < 0.3
          example: 89

    # === Error Types (RFC 7807) ===

    ProblemDetails:
      type: object
      description: RFC 7807 Problem Details for HTTP APIs
      required:
        - type
        - title
        - status
      properties:
        type:
          type: string
          format: uri
          description: URI identifying the error type
          example: "https://engram.dev/errors/validation-error"
        title:
          type: string
          description: Human-readable error summary
          example: "Validation Error"
        status:
          type: integer
          description: HTTP status code
          example: 422
        detail:
          type: string
          description: Human-readable explanation
          example: "Request contains invalid fields"
        instance:
          type: string
          description: URI of the request that caused the error
          example: "/api/v1/lore"

    ProblemDetailsWithErrors:
      allOf:
        - $ref: '#/components/schemas/ProblemDetails'
        - type: object
          properties:
            errors:
              type: array
              items:
                $ref: '#/components/schemas/ValidationError'
              description: Field-level validation errors

    ValidationError:
      type: object
      description: Single field validation error
      properties:
        field:
          type: string
          description: Field path that failed validation
          example: "lore[0].content"
        message:
          type: string
          description: Error message
          example: "exceeds maximum length of 4000 characters"

  responses:
    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: "https://engram.dev/errors/unauthorized"
            title: "Unauthorized"
            status: 401
            detail: "Missing or invalid Authorization header"
            instance: "/api/v1/lore"

security:
  - bearerAuth: []
