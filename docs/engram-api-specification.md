# Engram API Specification

**Version:** 1.0
**Last Updated:** 2026-01-28
**Base URL:** `https://{host}/api/v1`

---

## Table of Contents

1. [Overview](#overview)
2. [Authentication](#authentication)
3. [Common Patterns](#common-patterns)
4. [Endpoints](#endpoints)
   - [Health Check](#health-check)
   - [Lore Ingestion](#lore-ingestion)
   - [Snapshot](#snapshot)
   - [Delta Sync](#delta-sync)
   - [Feedback](#feedback)
5. [Data Schemas](#data-schemas)
6. [Error Handling](#error-handling)
7. [Validation Rules](#validation-rules)
8. [Performance Targets](#performance-targets)
9. [Sync Lifecycle](#sync-lifecycle)

---

## Overview

Engram is the central lore service for AI agent memory. It provides persistence and synchronization for agent-generated knowledge ("lore") across sessions, projects, and distributed development environments.

### Key Characteristics

- **Persistence hub** — Engram stores lore centrally; recall/search happens client-side
- **Server-side embedding** — All embeddings generated by Engram using `text-embedding-3-small` (1536 dimensions)
- **Semantic deduplication** — Equivalent lore from different sources merges rather than duplicates
- **Confidence model** — Feedback-driven scoring where helpful lore rises and stale lore decays

### API Design Principles

- RESTful JSON API for all endpoints except snapshot (binary)
- URL path versioning (`/api/v1/`)
- RFC 7807 Problem Details for all error responses
- Snake_case for all JSON field names
- RFC 3339 for all timestamps
- ULID for all identifiers

---

## Authentication

All endpoints except `/api/v1/health` require Bearer token authentication.

### Request Header

```http
Authorization: Bearer <api_key>
```

### Authentication Errors

Missing or invalid authentication returns `401 Unauthorized`:

```json
{
  "type": "https://engram.dev/errors/unauthorized",
  "title": "Unauthorized",
  "status": 401,
  "detail": "Missing or invalid API key",
  "instance": "/api/v1/lore"
}
```

### Security Notes

- All communication must use HTTPS (TLS 1.2+)
- API keys are never logged or included in error responses
- Single API key per organization/team scope (v1)

---

## Common Patterns

### Timestamps

All timestamps use RFC 3339 format in UTC:

```
2026-01-28T14:30:00Z
```

### Identifiers

All IDs are ULIDs (Universally Unique Lexicographically Sortable Identifiers):

```
01ARYZ6S41TSV4RRFFQ69G5FAV
```

ULID characteristics:
- 26 characters
- Crockford Base32 encoding (excludes I, L, O, U)
- Lexicographically sortable by creation time

### Content Types

| Endpoint | Request | Response |
|----------|---------|----------|
| Health | — | `application/json` |
| Lore Ingest | `application/json` | `application/json` |
| Snapshot | — | `application/octet-stream` |
| Delta | — | `application/json` |
| Feedback | `application/json` | `application/json` |
| Errors | — | `application/problem+json` |

### Empty Arrays

Empty arrays are always returned as `[]`, never `null`:

```json
{"lore": [], "deleted_ids": [], "errors": []}
```

---

## Endpoints

### Health Check

Check service health and retrieve configuration metadata.

```
GET /api/v1/health
```

**Authentication:** Not required

**Response:** `200 OK`

```json
{
  "status": "healthy",
  "version": "1.0.0",
  "embedding_model": "text-embedding-3-small",
  "lore_count": 1234,
  "last_snapshot": "2026-01-28T12:00:00Z"
}
```

**Response Fields:**

| Field | Type | Description |
|-------|------|-------------|
| `status` | string | Service status: `"healthy"` or `"degraded"` |
| `version` | string | Engram service version |
| `embedding_model` | string | Embedding model identifier for compatibility checking |
| `lore_count` | integer | Total number of lore entries in the store |
| `last_snapshot` | string (RFC 3339) or null | Timestamp of last snapshot generation |

**Use Cases:**
- Verify service availability before sync operations
- Detect embedding model mismatches (client should warn if local model differs)
- Monitor lore growth and snapshot freshness

---

### Lore Ingestion

Submit lore entries in batch for persistent storage.

```
POST /api/v1/lore
```

**Authentication:** Required

**Request:**

```json
{
  "source_id": "devcontainer-abc123",
  "lore": [
    {
      "content": "ORM generates N+1 queries for polymorphic associations unless eager loading is explicitly configured",
      "context": "Discovered while profiling Rails app performance",
      "category": "DEPENDENCY_BEHAVIOR",
      "confidence": 0.7
    },
    {
      "content": "Queue consumers benefit from idempotency verification in integration tests",
      "context": "Learned after debugging flaky test suite",
      "category": "TESTING_STRATEGY",
      "confidence": 0.75
    }
  ],
  "flush": false
}
```

**Request Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `source_id` | string | Yes | Identifier for the source environment (e.g., devcontainer ID) |
| `lore` | array | Yes | Array of lore entries (1-50 entries) |
| `lore[].content` | string | Yes | The lore content (max 4000 characters) |
| `lore[].context` | string | No | Optional context about when/where lore was discovered (max 1000 characters) |
| `lore[].category` | string | Yes | Lore category (see [Categories](#lore-categories)) |
| `lore[].confidence` | number | Yes | Initial confidence score (0.0 to 1.0) |
| `flush` | boolean | No | If true, indicates shutdown flush (prioritize processing) |

**Response:** `200 OK`

```json
{
  "accepted": 2,
  "merged": 0,
  "rejected": 0,
  "errors": []
}
```

**Response Fields:**

| Field | Type | Description |
|-------|------|-------------|
| `accepted` | integer | Number of entries successfully stored as new lore |
| `merged` | integer | Number of entries merged with existing semantically equivalent lore |
| `rejected` | integer | Number of entries rejected due to validation errors |
| `errors` | array | Validation error messages for rejected entries |

**Partial Success Response:**

When some entries are valid and others are not:

```json
{
  "accepted": 1,
  "merged": 0,
  "rejected": 1,
  "errors": [
    "lore[1].content: exceeds maximum length of 4000 characters"
  ]
}
```

**Processing Behavior:**

1. **Validation** — Each entry is validated independently
2. **Partial acceptance** — Valid entries are processed even if others fail
3. **Embedding generation** — Server generates embeddings asynchronously
4. **Deduplication** — Entries are checked against existing lore (cosine similarity >= 0.92 within same category)
5. **Merge strategy** — Duplicates merge: confidence +0.10, context appended, sources aggregated

**Note:** Entries are accepted immediately with `embedding_status = "pending"`. Embedding generation occurs asynchronously. This ensures lore acceptance is not blocked by embedding API availability.

---

### Snapshot

Download a full database snapshot for client bootstrap.

```
GET /api/v1/lore/snapshot
```

**Authentication:** Required

**Response:** `200 OK`

- **Content-Type:** `application/octet-stream`
- **Body:** Binary SQLite database file

The snapshot contains:
- All lore entries with complete metadata
- Precomputed embeddings (packed float32 arrays)
- Source tracking information

**Response Headers:**

```http
Content-Type: application/octet-stream
Content-Disposition: attachment; filename="engram-snapshot.db"
Content-Length: 73400320
```

**Error Responses:**

| Status | Condition |
|--------|-----------|
| `503 Service Unavailable` | Snapshot generation in progress |

**Use Cases:**
- Initial client bootstrap (new devcontainer)
- Full resync after corruption or long offline period
- Database recovery

**Implementation Notes:**
- Snapshots are pre-generated and cached
- Snapshot regeneration runs as a background job
- Clients should replace their local store entirely, then set `last_sync` timestamp

---

### Delta Sync

Request incremental lore changes since a given timestamp.

```
GET /api/v1/lore/delta?since={timestamp}
```

**Authentication:** Required

**Query Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `since` | string (RFC 3339) | Yes | Timestamp of last successful sync |

**Example Request:**

```
GET /api/v1/lore/delta?since=2026-01-28T10:00:00Z
```

**Response:** `200 OK`

```json
{
  "lore": [
    {
      "id": "01ARYZ6S41TSV4RRFFQ69G5FAV",
      "content": "Event sourcing adds unnecessary complexity for simple CRUD operations",
      "context": "Architecture review for inventory service",
      "category": "ARCHITECTURAL_DECISION",
      "confidence": 0.85,
      "embedding": [0.123, -0.456, 0.789, ...],
      "source_id": "devcontainer-xyz789",
      "sources": ["devcontainer-xyz789", "devcontainer-abc123"],
      "validation_count": 3,
      "created_at": "2026-01-27T08:30:00Z",
      "updated_at": "2026-01-28T11:15:00Z",
      "last_validated_at": "2026-01-28T11:15:00Z",
      "embedding_status": "complete"
    }
  ],
  "deleted_ids": [
    "01ARYZ6S41TSV4RRFFQ69G5ABC"
  ],
  "as_of": "2026-01-28T14:30:00Z"
}
```

**Response Fields:**

| Field | Type | Description |
|-------|------|-------------|
| `lore` | array | Lore entries created or updated since `since` timestamp |
| `deleted_ids` | array | IDs of lore entries deleted since `since` timestamp |
| `as_of` | string (RFC 3339) | Server timestamp when delta was computed (use as next `since`) |

**Lore Entry Fields:**

| Field | Type | Description |
|-------|------|-------------|
| `id` | string (ULID) | Unique identifier |
| `content` | string | Lore content |
| `context` | string | Optional context |
| `category` | string | Lore category |
| `confidence` | number | Current confidence score (0.0-1.0) |
| `embedding` | array | Float32 embedding vector (1536 dimensions) |
| `source_id` | string | Original source environment |
| `sources` | array | All contributing source environments |
| `validation_count` | integer | Number of positive validations |
| `created_at` | string (RFC 3339) | Creation timestamp |
| `updated_at` | string (RFC 3339) | Last update timestamp |
| `last_validated_at` | string (RFC 3339) or null | Last positive feedback timestamp |
| `embedding_status` | string | `"complete"`, `"pending"`, or `"failed"` |

**Error Responses:**

| Status | Condition |
|--------|-----------|
| `400 Bad Request` | Invalid or missing `since` timestamp |

**Use Cases:**
- Incremental sync during active session
- Sync after task completion
- Periodic background sync

---

### Feedback

Submit batch feedback on recalled lore entries.

```
POST /api/v1/lore/feedback
```

**Authentication:** Required

**Request:**

```json
{
  "source_id": "devcontainer-abc123",
  "feedback": [
    {
      "id": "01ARYZ6S41TSV4RRFFQ69G5FAV",
      "outcome": "helpful"
    },
    {
      "id": "01ARYZ6S41TSV4RRFFQ69G5XYZ",
      "outcome": "not_relevant"
    },
    {
      "id": "01ARYZ6S41TSV4RRFFQ69G5ABC",
      "outcome": "incorrect"
    }
  ]
}
```

**Request Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `source_id` | string | Yes | Identifier for the source environment |
| `feedback` | array | Yes | Array of feedback entries (1-50 entries) |
| `feedback[].id` | string (ULID) | Yes | Lore entry ID |
| `feedback[].outcome` | string | Yes | Feedback type (see below) |

**Feedback Outcomes:**

| Outcome | Effect | Description |
|---------|--------|-------------|
| `helpful` | confidence +0.08 | Lore was useful for the task |
| `not_relevant` | confidence +0.00 | Lore was not applicable to this context |
| `incorrect` | confidence -0.15 | Lore was wrong or misleading |

**Response:** `200 OK`

```json
{
  "updates": [
    {
      "id": "01ARYZ6S41TSV4RRFFQ69G5FAV",
      "previous": 0.85,
      "current": 0.93,
      "validation_count": 4
    },
    {
      "id": "01ARYZ6S41TSV4RRFFQ69G5XYZ",
      "previous": 0.70,
      "current": 0.70,
      "validation_count": 2
    },
    {
      "id": "01ARYZ6S41TSV4RRFFQ69G5ABC",
      "previous": 0.60,
      "current": 0.45,
      "validation_count": 1
    }
  ]
}
```

**Response Fields:**

| Field | Type | Description |
|-------|------|-------------|
| `updates` | array | Results for each feedback entry |
| `updates[].id` | string (ULID) | Lore entry ID |
| `updates[].previous` | number | Confidence before adjustment |
| `updates[].current` | number | Confidence after adjustment |
| `updates[].validation_count` | integer | Updated validation count |

**Confidence Boundaries:**
- Maximum: 1.0 (capped regardless of positive feedback)
- Minimum: 0.0 (floored regardless of negative feedback)

**Side Effects:**
- `helpful` feedback increments `validation_count` and updates `last_validated_at`
- `not_relevant` feedback has no side effects beyond being recorded
- `incorrect` feedback does not affect `validation_count`

**Error Responses:**

| Status | Condition |
|--------|-----------|
| `404 Not Found` | One or more lore IDs not found |
| `422 Unprocessable Entity` | Invalid feedback data |

---

## Data Schemas

### Lore Entry

Complete lore entry as returned by delta sync:

```json
{
  "id": "01ARYZ6S41TSV4RRFFQ69G5FAV",
  "content": "ORM generates N+1 queries for polymorphic associations",
  "context": "Discovered while profiling Rails app",
  "category": "DEPENDENCY_BEHAVIOR",
  "confidence": 0.78,
  "embedding": [0.123, -0.456, ...],
  "source_id": "devcontainer-abc123",
  "sources": ["devcontainer-abc123", "devcontainer-xyz789"],
  "validation_count": 2,
  "created_at": "2026-01-27T08:30:00Z",
  "updated_at": "2026-01-28T11:15:00Z",
  "last_validated_at": "2026-01-28T11:15:00Z",
  "embedding_status": "complete"
}
```

### Lore Categories

Valid category values:

| Category | Description |
|----------|-------------|
| `ARCHITECTURAL_DECISION` | High-level design choices and their outcomes |
| `PATTERN_OUTCOME` | Results of applying specific patterns |
| `INTERFACE_LESSON` | Lessons about API design and contracts |
| `EDGE_CASE_DISCOVERY` | Unexpected behaviors and boundary conditions |
| `IMPLEMENTATION_FRICTION` | Difficulties encountered during implementation |
| `TESTING_STRATEGY` | Insights about testing approaches |
| `DEPENDENCY_BEHAVIOR` | Behaviors of libraries and frameworks |
| `PERFORMANCE_INSIGHT` | Performance-related discoveries |

### Embedding Format

Embeddings are 1536-dimensional float32 vectors generated by OpenAI's `text-embedding-3-small` model.

**In JSON responses:**
```json
"embedding": [0.123, -0.456, 0.789, ...]
```

**In SQLite snapshot:**
- Stored as packed binary float32 (little-endian)
- ~6KB per entry

### Embedding Status

| Status | Description |
|--------|-------------|
| `complete` | Embedding successfully generated |
| `pending` | Embedding queued for generation |
| `failed` | Embedding generation failed after retries |

---

## Error Handling

All errors follow RFC 7807 Problem Details format.

### Problem Details Structure

```json
{
  "type": "https://engram.dev/errors/{error-type}",
  "title": "Human-Readable Title",
  "status": 400,
  "detail": "Specific error description",
  "instance": "/api/v1/lore"
}
```

| Field | Type | Description |
|-------|------|-------------|
| `type` | string (URI) | Error type identifier |
| `title` | string | Short, human-readable summary |
| `status` | integer | HTTP status code |
| `detail` | string | Detailed explanation |
| `instance` | string | Request path that caused the error |

### Validation Errors (422)

Validation errors include an additional `errors` array:

```json
{
  "type": "https://engram.dev/errors/validation-error",
  "title": "Validation Error",
  "status": 422,
  "detail": "Request contains invalid fields",
  "instance": "/api/v1/lore",
  "errors": [
    {"field": "source_id", "message": "is required"},
    {"field": "lore[0].content", "message": "exceeds maximum length of 4000 characters"},
    {"field": "lore[1].category", "message": "must be one of: ARCHITECTURAL_DECISION, PATTERN_OUTCOME, ..."}
  ]
}
```

### Error Type Reference

| Type URI | Status | Title | When |
|----------|--------|-------|------|
| `https://engram.dev/errors/unauthorized` | 401 | Unauthorized | Missing/invalid API key |
| `https://engram.dev/errors/bad-request` | 400 | Bad Request | Malformed JSON, invalid parameters |
| `https://engram.dev/errors/not-found` | 404 | Not Found | Resource not found |
| `https://engram.dev/errors/validation-error` | 422 | Validation Error | Field validation failures |
| `https://engram.dev/errors/conflict` | 409 | Conflict | Duplicate entry conflict |
| `https://engram.dev/errors/service-unavailable` | 503 | Service Unavailable | Snapshot in progress, embedding unavailable |
| `https://engram.dev/errors/internal-error` | 500 | Internal Server Error | Unexpected server error |

### HTTP Status Code Summary

| Code | Meaning | Used By |
|------|---------|---------|
| 200 | Success | All endpoints |
| 400 | Bad request (malformed JSON, invalid parameters) | All endpoints |
| 401 | Unauthorized (missing/invalid API key) | All authenticated endpoints |
| 404 | Not found (lore ID not found) | Feedback |
| 422 | Unprocessable entity (validation errors) | Ingest, Feedback |
| 429 | Too many requests (reserved for future) | — |
| 500 | Internal server error | All endpoints |
| 503 | Service unavailable (snapshot in progress) | Snapshot |

---

## Validation Rules

### Lore Content

| Field | Constraint |
|-------|------------|
| `content` | Required, 1-4000 characters, valid UTF-8, no null bytes |
| `context` | Optional, 0-1000 characters, valid UTF-8, no null bytes |
| `category` | Required, must be valid category enum value |
| `confidence` | Required, decimal between 0.0 and 1.0 (inclusive) |

### Request-Level

| Field | Constraint |
|-------|------------|
| `source_id` | Required, non-empty string |
| `lore` array | Required, 1-50 entries |
| `feedback` array | Required, 1-50 entries |

### ID Format

| Field | Constraint |
|-------|------------|
| `id` | ULID format: 26 characters, Crockford Base32 |

### Character Encoding

- All string fields must be valid UTF-8
- Null bytes (`\x00`) are rejected
- Length limits are measured in Unicode code points (runes), not bytes

---

## Performance Targets

| Operation | Target | Conditions |
|-----------|--------|------------|
| Lore ingest | < 5 seconds | Up to 50 entries including embedding generation |
| Snapshot serving | < 10 seconds | Database up to 70MB (~10k entries) |
| Delta sync | < 1 second | Typical delta (< 100 entries) |
| Feedback processing | < 500ms | Up to 50 feedback entries |
| Health check | < 100ms | Always |
| Deduplication overhead | < 2 seconds | Per entry at < 10k total entries |

### Scalability Limits (v1)

| Metric | Limit |
|--------|-------|
| Concurrent environments | 20 devcontainers |
| Total lore entries | 10,000 |
| Snapshot size | < 100MB |
| Batch size (ingest) | 50 entries |
| Batch size (feedback) | 50 entries |
| Sync interval | 5-60 minutes per environment |

---

## Sync Lifecycle

### Bootstrap (New Client)

```
1. GET /api/v1/health
   → Verify service healthy, check embedding_model compatibility

2. GET /api/v1/lore/snapshot
   → Download full database snapshot

3. Replace local store with snapshot
   → Set last_sync = snapshot timestamp
   → Ready for local semantic search
```

### Incremental Sync (Active Session)

```
1. POST /api/v1/lore
   → Push pending lore entries

2. POST /api/v1/lore/feedback
   → Push pending feedback

3. GET /api/v1/lore/delta?since={last_sync}
   → Pull changes from other environments

4. Apply delta to local store
   → Update last_sync = as_of from response
```

### Shutdown Flush

```
1. POST /api/v1/lore (flush: true)
   → Push all remaining lore entries

2. POST /api/v1/lore/feedback
   → Push all remaining feedback

3. (Optional) GET /api/v1/lore/delta?since={last_sync}
   → Final sync if needed
```

### Sync Timing Recommendations

| Event | Action |
|-------|--------|
| Client startup | Full snapshot bootstrap |
| Task completion | Incremental sync (push lore, push feedback, pull delta) |
| Periodic (5-60 min) | Incremental sync |
| Client shutdown | Flush all pending operations |
| Long offline period | Consider full snapshot resync |

### Conflict Resolution

- **Last-write-wins** for updates to the same lore entry
- **Semantic deduplication** merges equivalent content from different sources
- **Deleted entries** reported in delta for client cleanup
- **Embedding model mismatch** — client should warn user but can continue (search quality may degrade)

---

## Appendix: Example Flows

### Recording New Lore

```http
POST /api/v1/lore HTTP/1.1
Host: engram.example.com
Authorization: Bearer sk_live_abc123
Content-Type: application/json

{
  "source_id": "devcontainer-team-alpha-01",
  "lore": [
    {
      "content": "Redis SCAN cursor must be stored as string, not integer, to handle large keyspaces correctly",
      "context": "Debugging pagination issue in cache invalidation job",
      "category": "DEPENDENCY_BEHAVIOR",
      "confidence": 0.75
    }
  ]
}
```

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "accepted": 1,
  "merged": 0,
  "rejected": 0,
  "errors": []
}
```

### Providing Feedback

```http
POST /api/v1/lore/feedback HTTP/1.1
Host: engram.example.com
Authorization: Bearer sk_live_abc123
Content-Type: application/json

{
  "source_id": "devcontainer-team-alpha-01",
  "feedback": [
    {"id": "01HQ5K9X2YPZV3CMWN8BTRFJ4G", "outcome": "helpful"},
    {"id": "01HQ5K9X2YPZV3CMWN8BTRFJ4H", "outcome": "incorrect"}
  ]
}
```

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "updates": [
    {"id": "01HQ5K9X2YPZV3CMWN8BTRFJ4G", "previous": 0.80, "current": 0.88, "validation_count": 5},
    {"id": "01HQ5K9X2YPZV3CMWN8BTRFJ4H", "previous": 0.65, "current": 0.50, "validation_count": 2}
  ]
}
```

### Handling Validation Errors

```http
POST /api/v1/lore HTTP/1.1
Host: engram.example.com
Authorization: Bearer sk_live_abc123
Content-Type: application/json

{
  "source_id": "",
  "lore": []
}
```

```http
HTTP/1.1 422 Unprocessable Entity
Content-Type: application/problem+json

{
  "type": "https://engram.dev/errors/validation-error",
  "title": "Validation Error",
  "status": 422,
  "detail": "Request contains invalid fields",
  "instance": "/api/v1/lore",
  "errors": [
    {"field": "source_id", "message": "is required"},
    {"field": "lore", "message": "is required and must not be empty"}
  ]
}
```

---

## Document History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-01-28 | Initial specification |
